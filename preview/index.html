<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#73C2FB" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Letter Loom" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="Letter Loom" />
    <meta name="screen-orientation" content="portrait" />
    <meta name="orientation" content="portrait" />
    <meta name="display" content="standalone" />
    <link rel="apple-touch-icon" href="assets/icon-192.png" />
    <link rel="icon" sizes="192x192" href="assets/icon-192.png" />
    <link rel="icon" sizes="512x512" href="assets/icon-512.png" />

  <title>Letter Loom Prototype</title>
  <style>
    :root {
      --game-width: 360px;
      --game-height: 640px;
    }
    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: green;
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -moz-user-select: none;
      touch-action: none;
    }
    body {
      overscroll-behavior: none;
    }
    #game-root {
      width: var(--game-width);
      height: var(--game-height);
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: top left;
      box-shadow: 0 0 32px #0004;
      border-radius: 20px;
      background: transparent;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -moz-user-select: none;
      background-color: red;
    }
    .game-content {
      background-color: orange;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    header.game-header {
      width: 100%;
      flex: 0 0 auto;
      background: #428BCA;
      color: #fff;
      font-family: 'Fredoka', Arial, sans-serif;
      font-size: 1.3em;
      text-align: center;
      padding: 0.7em 0.5em;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 2px 8px #428bca22;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    main.game-main {
      flex: 1 1 auto;
      overflow-y: auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 1em 0.5em;
      background: #fff;
    }
    footer.game-footer {
      width: 100%;
      flex: 0 0 auto;
      background: #428BCA;
      color: #fff;
      font-family: 'Fredoka', Arial, sans-serif;
      font-size: 1em;
      text-align: center;
      padding: 0.5em 0.5em;
      border-bottom-left-radius: 16px;
      border-bottom-right-radius: 16px;
      box-shadow: 0 -2px 8px #428bca22;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .demo-panel {
      width: 160px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 8px #0002;
      padding: 24px;
      text-align: center;
      font-family: 'Fredoka', Arial, sans-serif;
    }
    .demo-title {
      font-size: 2.2em;
      font-weight: bold;
      margin-bottom: 1em;
      color: #428BCA;
      font-family: 'Bangers', cursive;
    }
    .demo-btn {
      font-size: 1.2em;
      padding: 0.7em 2em;
      border-radius: 8px;
      border: none;
      background: #73C2FB;
      color: #fff;
      font-weight: bold;
      margin-top: 2em;
      cursor: pointer;
      box-shadow: 0 2px 8px #428bca22;
      transition: background 0.2s;
    }
    .demo-btn:hover {
      background: #428BCA;
    }
    /* Overlay para orientación incorrecta */
    #orientation-overlay {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.9);
      color: #222;
      font-family: 'Fredoka', Arial, sans-serif;
      font-size: 4vw;
      text-align: center;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 4vw;
      pointer-events: none;
    }
    .orientation-icon {
      width: 25vw;
      max-width: 128px;
      min-width: 128px;
      height: auto;
      margin-bottom: 2vw;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    #orientation-overlay.active {
      display: flex;
      pointer-events: auto;
    }
    #videoWakeLockWorkaround {
            width: 1px; 
            height: 1px; 
            opacity: 0; 
            position: absolute;
        }    
  </style>
  <meta name="screen-orientation" content="portrait">
</head>
<body>
  <div id="orientation-overlay">
    <div>
      <img src="assets/rotate-device-icon.png" alt="Gira el dispositivo" class="orientation-icon">
      <div id="orientation-message" style="display:none;">
        Por favor, gira tu dispositivo a <b>VERTICAL</b> para jugar.<br><br>
      </div>
    </div>
  </div>
  <div id="game-root">
    <div class="game-content">
      <header class="game-header" id="gameHeader">
        Letter Loom Prototype
      </header>
      <main class="game-main" id="gameMain">
        <div class="demo-panel">
          <div class="demo-title">Letter Loom</div>
          <div style="font-size:1.1em; color:#444; margin-bottom:1em;">Prototipo escalado<br><span id="screen-info" style="font-size:0.8em; color:#555;"></span></div>
          <div style="display:none">
            <div style="margin-bottom:2em;">Este área se escala y se centra automáticamente.<br>Prueba en diferentes móviles y orientaciones.</div>        
            <button class="demo-btn" id="wakeLockBtn">Activar bloqueo de pantalla</button>
            <div id="wakeLockStatus" style="margin-top:1em; font-size:0.95em; color:#428BCA;"></div>
          </div>
          <div id="lorem-normal">loren ipsum loren </div>
          <button class="demo-btn" id="toggleLoremHugeBtn" style="margin-top:1em;">SW Loren</button>
          <div id="lorem-huge" style="display:none;">loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum l</div>
            <button class="demo-btn" id="toggleHeaderBtn" style="margin-top:1em;">Mostrar/ocultar header</button>
            <button class="demo-btn" id="toggleFooterBtn" style="margin-top:1em;">Mostrar/ocultar footer</button>
        </div>
      </main>
      <footer class="game-footer" id="gameFooter">
        &copy; 2024 Letter Loom
      </footer>
    </div>
  </div>
  <video id="videoWakeLockWorkaround" loop muted playsinline>
        <source src="assets/empty-video.mp4" type="video/mp4">
        Tu navegador no soporta el elemento de video.
  </video>  
  <script type="module">
    // Prevención de zoom por doble tap y pinch
    (function preventMobileZoom() {
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function (event) {
        const now = Date.now();
        if (now - lastTouchEnd <= 350) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, { passive: false });
      document.addEventListener('gesturestart', function (e) {
        e.preventDefault();
      });
      document.addEventListener('gesturechange', function (e) {
        e.preventDefault();
      });
      document.addEventListener('gestureend', function (e) {
        e.preventDefault();
      });
    })();
    // Mostrar/ocultar el texto grande
    document.addEventListener('DOMContentLoaded', function() {
      const toggleBtn = document.getElementById('toggleLoremHugeBtn');
      const loremHuge = document.getElementById('lorem-huge');
      toggleBtn.addEventListener('click', function() {
        if (loremHuge.style.display === 'none') {
          loremHuge.style.display = '';
        } else {
          loremHuge.style.display = 'none';
        }
      });
        // Mostrar/ocultar header y footer
        const toggleHeaderBtn = document.getElementById('toggleHeaderBtn');
        const header = document.getElementById('gameHeader');
        toggleHeaderBtn.addEventListener('click', function() {
          if (header.style.display === 'none') {
            header.style.display = '';
          } else {
            header.style.display = 'none';
          }
        });

        const toggleFooterBtn = document.getElementById('toggleFooterBtn');
        const footer = document.getElementById('gameFooter');
        toggleFooterBtn.addEventListener('click', function() {
          if (footer.style.display === 'none') {
            footer.style.display = '';
          } else {
            footer.style.display = 'none';
          }
        });
    });
    import { initWakeLockManager, requestLock, releaseLock } from './src/wakeLockManager.js';
    const videoWakeLockWorkaroundEl = document.getElementById('videoWakeLockWorkaround');
    const statusWakeLocEl = document.getElementById('wakeLockStatus');
    let lockActive = false;
    initWakeLockManager({ videoEl: videoWakeLockWorkaroundEl, statusEl: statusWakeLocEl });
    const btn = document.getElementById('wakeLockBtn');
    btn.addEventListener('click', async () => {
      if (!lockActive) {
        await requestLock();
        btn.textContent = 'Desactivar bloqueo de pantalla';
        lockActive = true;
      } else {
        await releaseLock();
        btn.textContent = 'Activar bloqueo de pantalla';
        lockActive = false;
      }
    });
    // Overlay de orientación: muestra si está en landscape
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    function getViewportZoom() {
      if (window.visualViewport && typeof window.visualViewport.scale === 'number') {
        return window.visualViewport.scale;
      }
      // Fallback: calcula zoom como antes
      const { width: GAME_WIDTH, height: GAME_HEIGHT } = getGameDimensions();
      const deviceW = window.innerWidth;
      const deviceH = window.innerHeight;
      return Math.min(deviceW / GAME_WIDTH, deviceH / GAME_HEIGHT);
    }

    function updateScreenInfo() {
      const info = document.getElementById('screen-info');
      if (!info) return;
      const { width: GAME_WIDTH, height: GAME_HEIGHT } = getGameDimensions();
      const deviceW = window.innerWidth;
      const deviceH = window.innerHeight;
      const zoom = getViewportZoom();
      info.innerHTML = `Juego: ${GAME_WIDTH}x${GAME_HEIGHT}px<br>Dispositivo: ${deviceW}x${deviceH}px<br>Zoom: ${zoom.toFixed(2)}x`;
    }

    function checkOrientationOverlay() {
      const overlay = document.getElementById('orientation-overlay');
      const message = document.getElementById('orientation-message');
      updateScreenInfo();
      const isLandscape = window.innerWidth > window.innerHeight;
      if (isMobileDevice() && isLandscape) {
        overlay.classList.add('active');
        message.style.display = '';
      } else {
        overlay.classList.remove('active');
        message.style.display = 'none';
      }
    }
    function getGameDimensions() {
      const root = getComputedStyle(document.documentElement);
      return {
        width: parseFloat(root.getPropertyValue('--game-width')),
        height: parseFloat(root.getPropertyValue('--game-height'))
      };
    }
    function scaleGame() {
      const game = document.getElementById('game-root');
      const { width: GAME_WIDTH, height: GAME_HEIGHT } = getGameDimensions();
      const w = window.innerWidth;
      const h = window.innerHeight;
      const scale = Math.min(w / GAME_WIDTH, h / GAME_HEIGHT);
      game.style.transform = `scale(${scale})`;
      game.style.left = `${(w - GAME_WIDTH * scale) / 2}px`;
      game.style.top = `${(h - GAME_HEIGHT * scale) / 2}px`;
      checkOrientationOverlay();      
    }
    window.addEventListener('resize', scaleGame);
    window.addEventListener('orientationchange', scaleGame);
    window.addEventListener('DOMContentLoaded', scaleGame);
  </script>
</body>
</html>
